#!/bin/bash
echo '  /$$$$$$                             /$$$$$$  /$$$$$$$  /$$$$$$' 
echo ' /$$__  $$                           /$$__  $$| $$__  $$|_  $$_/'
echo '| $$  \__/ /$$   /$$  /$$$$$$       | $$  \ $$| $$  \ $$  | $$  '
echo '| $$      | $$  | $$ /$$__  $$      | $$$$$$$$| $$$$$$$/  | $$  '
echo '| $$      | $$  | $$| $$$$$$$$      | $$__  $$| $$____/   | $$  '
echo '| $$    $$| $$  | $$| $$_____/      | $$  | $$| $$        | $$  '
echo '|  $$$$$$/|  $$$$$$/|  $$$$$$$      | $$  | $$| $$       /$$$$$$'
echo ' \______/  \______/  \_______/      |__/  |__/|__/      |______/'
iamUser=$(aws iam get-user --query 'User.UserName')
if [ $? -ne 0 ]
then
  echo -e 'You are not signed in as an IAM user.\n'
  return 3
fi
accessKeyId=$(aws configure get aws_access_key_id)
if [ $? -ne 0 ]; then
  echo -e 'Your AWS access is not configured.\nRun \$ \`aws configure to set\` credentials.\n'
  return 3
fi
python etc/render.py $(aws configure get region)
echo 'Bringing up a Cue stack for IAM user $iamUser in the $region region...'
aws cloudformation validate-template --template-body file://etc/network.cue-api.cfn.yml
if [$? -ne 0]
then
  echo 'The network template is not valid.'
  return 3
fi
aws cloudformation validate-template --template-body file://run/server.cue-api.cfn.yml
if [ $? -ne 0 ]
then
  echo 'The server template is not valid.'
  return 3
fi
aws ec2 delete-key-pair --key-name key0-cue-api
rm -rf run/.keys
mkdir run/.keys
aws ec2 create-key-pair --key-name key0-cue-api --query 'KeyMaterial' --output text > run/.keys/key0-cue-api.pem
aws cloudformation create-stack --stack-name network-cue-api
aws cloudformation wait stack-create-complete --stack-name network-cue-api &
while [ $(ps -ef | grep aws | grep -v grep | wc -l) -gt 0]; do
  echo -n '.'
  sleep 1
done
echo 'Network stack build complete.'
aws cloudformation create-stack --stack-name server-cue-api --template-body file://run/server.cue-api.cfn.yml
aws cloudformation wait stack-create-complete --stack-name server-cue-api &
while [ $(ps -ef | grep aws | grep -v grep | wc -l) -gt 0]; do
  echo -n '.'
  sleep 1
done
echo 'Server stack build complete.'
ip=$(aws ec2 describe-instances --filter "Name=tag:aws:cloudformation:logical-id,Values=CueServer" --query 'Reservations[*].Instances[0].PublicIpAddress' --output text)
cat > run/ssh.cfg <<EOF
Host *
  User ubuntu
  PubkeyAuthentication yes

Host cue
  Hostname $ip
  IdentityFile run/.keys/key0-cue-api.pem
EOF
tar -cvf - src/ 
scp -F run/ssh.cfg -r 


